# T07 个人资料维护功能测试指南

## 功能概述

T07 任务实现了用户个人资料的维护功能，包括：
- ✅ 查看个人资料信息
- ✅ 更新姓名、联系方式、学院/单位等字段
- ✅ "我的预约"入口导航
- ✅ 前后端完整集成

## 技术实现

### 后端（Backend）

1. **数据模型** (`backend/app/models/user.py`)
   - User 模型包含所有用户字段
   - 支持三种借用人员类型（教师、学生、校外）

2. **API 端点** (`backend/app/api/v1/users.py`)
   - `GET /api/v1/users/me/profile` - 获取当前用户资料
   - `PUT /api/v1/users/me/profile` - 更新当前用户资料

3. **Schema** (`backend/app/schemas/user.py`)
   - UpdateProfileRequest - 资料更新请求验证

### 前端（Frontend）

1. **API 工具** (`frontend/src/api.js`)
   - 统一的 HTTP 请求封装
   - 自动处理 JWT Token
   - 用户认证和资料管理 API

2. **组件** (`frontend/src/components/ProfileView.vue`)
   - 响应式个人资料表单
   - 实时数据绑定
   - 错误处理和成功提示

## 测试步骤

### 1. 启动系统

在 Anaconda Prompt 中运行：

```powershell
cd SPPM-2025-LabSystem
.\start.ps1
```

等待启动完成，会自动打开两个窗口：
- 后端服务：http://localhost:11451
- 前端应用：http://localhost:5173

### 2. 测试用户注册

访问 http://localhost:5173，点击"注册"：

**测试数据示例：**

**学生账号：**
```
角色：校内学生
姓名：张三
联系方式：13800138000
学院：计算机学院
学号：S20260101
导师工号：T20240001
密码：password123
```

**教师账号：**
```
角色：校内教师
姓名：李老师
联系方式：13900139000
学院：材料学院
工号：T20260101
密码：teacher123
```

**校外人员：**
```
角色：校外人员
姓名：王工
联系方式：13700137000
单位名称：某科技公司
密码：external123
```

### 3. 测试登录

使用注册的账号登录系统。

### 4. 测试个人资料查看

1. 登录成功后，在侧边栏点击"个人资料"
2. 验证所有信息是否正确显示：
   - ✅ 姓名
   - ✅ 学号/工号（只读）
   - ✅ 学院/单位
   - ✅ 联系方式
   - ✅ 账号（只读）
   - ✅ 借用资格状态

### 5. 测试个人资料更新

1. 修改以下字段：
   - 姓名：改为"张三（测试）"
   - 联系方式：改为"13888888888"
   - 学院：改为"软件学院"

2. 点击"保存修改"按钮

3. 验证保存结果：
   - ✅ 显示"资料保存成功"提示
   - ✅ 数据自动刷新
   - ✅ 刷新页面后数据仍然保持

### 6. 测试"我的预约"入口

1. 在个人资料页面，点击"查看我的预约"按钮
2. 验证是否正确跳转到"我的预约"页面

### 7. 使用 API 文档测试

访问 http://localhost:11451/api/v1/docs

#### 7.1 测试注册 API
```
POST /api/v1/auth/register
{
  "role": "student",
  "name": "测试学生",
  "contact": "13800000001",
  "college": "测试学院",
  "student_no": "S20260102",
  "advisor_no": "T20240002",
  "password": "testpassword"
}
```

#### 7.2 测试登录 API
```
POST /api/v1/auth/login
{
  "account": "S20260102",
  "password": "testpassword",
  "role": "student"
}
```

复制返回的 `access_token`

#### 7.3 测试获取资料 API
```
GET /api/v1/users/me/profile
Headers: 
  Authorization: Bearer <your_access_token>
```

#### 7.4 测试更新资料 API
```
PUT /api/v1/users/me/profile
Headers: 
  Authorization: Bearer <your_access_token>
Body:
{
  "name": "测试学生（已更新）",
  "contact": "13900000001",
  "college": "新学院"
}
```

## 数据库验证

使用 SQLite 工具查看数据库：

```powershell
# 安装 sqlite3（如未安装）
# 或使用 DB Browser for SQLite

# 查看用户表
sqlite3 data/lesms.db "SELECT * FROM users;"
```

## 预期结果

### 成功标准

- ✅ 用户可以成功注册三种类型账号
- ✅ 登录后能查看完整的个人资料
- ✅ 能够成功更新姓名、联系方式、学院等信息
- ✅ 更新后的数据持久化到数据库
- ✅ "我的预约"按钮正确导航
- ✅ 不同角色显示相应的字段（如学生显示导师、校外显示单位）
- ✅ 只读字段无法编辑（工号/学号、账号）
- ✅ API 返回正确的错误码和消息

### 性能要求

- 资料加载时间 < 200ms
- 更新保存时间 < 500ms
- 界面响应流畅，无卡顿

## 故障排查

### 问题 1: 无法保存资料
**原因：** Token 过期或无效
**解决：** 重新登录获取新 Token

### 问题 2: 数据未更新
**原因：** 数据库连接问题
**解决：** 检查 .env 中的 DB_URL，重启后端服务

### 问题 3: 前端无法连接后端
**原因：** CORS 或服务未启动
**解决：** 
1. 确认后端运行在 11451 端口
2. 检查浏览器控制台错误
3. 确认 frontend/src/api.js 中的 API_BASE_URL 正确

## 文件清单

### 新增文件

```
backend/app/api/v1/users.py          # 用户资料 API 端点
backend/app/schemas/user.py           # 用户 Schema
frontend/src/api.js                   # API 工具模块
```

### 修改文件

```
backend/app/api/v1/__init__.py        # 注册 users 路由
frontend/src/components/ProfileView.vue  # 连接后端 API
frontend/src/App.vue                  # 添加导航事件监听
start.ps1                             # 优化启动脚本
README.md                             # 更新使用文档
mission_list.txt                      # 标记任务完成
```

## 下一步

T07 任务已完成！接下来可以实现：

- **T09**: 设备台账 CRUD
- **T10**: 人员台账 CRUD
- **T11**: 预约台账结构

---

**测试完成日期：** 2026-01-01
**测试人员：** 开发团队
**状态：** ✅ 通过
